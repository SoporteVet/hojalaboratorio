<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Boleta de laboratorio clínico para pacientes veterinarios">
    <title>Laboratorio Clínico Veterinario</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="lab-header">
            <div class="header-top">
                <img src="logo.jpg" alt="Veterinaria Logo" class="logo">
                <div class="header-text">
                    <h1>Boleta Ingreso Laboratorio Clínico</h1>
                    <p class="subtitle">Yo te curo, Dios te sana</p>
                </div>
            </div>
            <div class="lab-info">
                <p><i class="fas fa-calendar-alt"></i> Fecha: <span id="current-date"></span></p>
                <p><i class="fas fa-hashtag"></i> Factura Nº: <input type="text" class="form-input" value=""></p>
            </div>
        </header>

        <form id="lab-form">
            <div class="content-wrapper">
                <section class="patient-info" aria-labelledby="patient-heading">
                    <h2 id="patient-heading"><i class="fas fa-paw"></i> Información del Paciente</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <i class="fas fa-cat"></i>
                            <p><strong>Paciente:</strong> <input type="text" name="nombre-paciente" class="form-input" placeholder="Nombre"></p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-dna"></i>
                            <p><strong>Raza:</strong> <input type="text" name="raza" class="form-input" placeholder="Raza"></p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-feather"></i>
                            <p><strong>Especie:</strong> 
                                <select name="especie" class="form-select">
                                    <option value="felino">Felino</option>
                                    <option value="canino">Canino</option>
                                    <option value="Conejo">Lagomorfo</option>
                                    <option value="Cuilo">Cuilo</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-venus-mars"></i>
                            <p><strong>Sexo:</strong> 
                                <select name="sexo" class="form-select">
                                    <option value="hembra">Hembra</option>
                                    <option value="macho">Macho</option>
                                </select>
                            </p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-birthday-cake"></i>
                            <p><strong>Edad:</strong> <input type="text" name="edad" class="form-input" placeholder="Edad"> 
                                <select name="unidad-edad" class="form-select-small">
                                    <option value="años">años</option>
                                    <option value="meses">meses</option>
                                </select>
                            </p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-weight"></i>
                            <p><strong>Peso:</strong> <input type="number" step="0.1" name="peso" class="form-input" placeholder="Peso"> kg</p>
                        </div>
                    </div>
                </section>

                <section class="owner-info" aria-labelledby="owner-heading">
                    <h2 id="owner-heading"><i class="fas fa-user"></i> Información del Propietario</h2>
                    <div class="info-grid">
                        <div class="info-item">
                            <i class="fas fa-id-card"></i>
                            <p><strong>Propietario:</strong> <input type="text" name="propietario" class="form-input" placeholder="Nombre completo"></p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <p><strong>Teléfono:</strong> <input type="tel" name="telefono" class="form-input" placeholder="Número de teléfono"></p>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-envelope"></i>
                            <p><strong>Correo:</strong> <input type="email" name="correo" class="form-input" placeholder="Correo electrónico"></p>
                        </div>
                    </div>
                </section>
                <button type="button" id="load-github" class="btn btn-secondary">
                    <i class="fab fa-github"></i> Cargar desde GitHub
                </button>
                <section class="notes-section">
                    <h2><i class="fas fa-clipboard"></i>Anamnesis</h2>
                    <div class="notes-container">
                        <textarea name="notas" class="notes-input" placeholder="Ingrese notas o síntomas relevantes aquí..."></textarea>
                    </div>
                </section>
            </div>
            
                <section class="test-info" aria-labelledby="test-heading">
                    <h2 id="test-heading"><i class="fas fa-flask"></i> Perfiles de Laboratorio</h2>
                    <div class="category-filter">
                        <label for="service-category"><i class="fas fa-filter"></i> Filtrar por categoría:</label>
                        <select id="service-category" class="form-select">
                            <option value="todos">Todos los servicios</option>
                            <option value="perfiles">Perfiles</option>
                            <option value="paneles">Paneles</option>
                            <option value="paneles-intensivos">Paneles Intensivos</option>
                            <option value="inmunohematologia">Inmunohematología/Banco de sangre</option>
                            <option value="infectocontagiosos">Paneles Infecto-Contagiosos</option>
                            <option value="pruebas-rapidas">Pruebas Rápidas</option>
                            <option value="inmunología">Inmunología, Hormona, Serología, Tiempos de Coagulación</option>
                            <option value="hemogramas">Hemogramas</option>
                            <option value="analitos">Analitos</option>
                            <option value="hormonas">Hormonas</option>
                            <option value="otros">Otros exámenes</option>
                        </select>
                    </div>
    
                    <div class="table-container">
                        <table id="services-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-vial"></i> Exámen a realizar</th>
                                    <th><i class="fas fa-tag"></i> Precio</th>
                                    <th><i class="fas fa-check"></i> Seleccionado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Químico General</strong> (Hg, Glu, Renal, Hepática, Alb, TP)
                                        <p class="test-description">Evalúa funciones metabólicas y orgánicas básicas.</p>
                                    </td>
                                    <td data-precio="37000">₡37,000</td>
                                    <td><input type="checkbox" name="test" value="quimico-general" data-precio="37000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Renal Completo</strong> (Hg, Glu, Crea, Bun-Crea, Au, P, Mg, Urea, Orina, Electrólitos)
                                        <p class="test-description">Evalúa la salud renal del paciente.</p>
                                    </td>
                                    <td data-precio="35000">₡35,000</td>
                                    <td><input type="checkbox" name="test" value="renal-completo" data-precio="35000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Hepático Completo</strong> (Hg, Glu, Renal, AST, ALT, GGT, ALP, P, Alb, TP, TBA, Urea, TG, TC, Glob, Glob-Alb, TBil, Dbil)
                                        <p class="test-description">Analiza función hepática.</p>
                                    </td>
                                    <td data-precio="30000">₡30,000</td>
                                    <td><input type="checkbox" name="test" value="hepatico-completo" data-precio="30000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Prequirúrgico</strong> (Hg, Glu, Renal, AST, ALT, Alb, TP, Tiempos de coagulación)
                                        <p class="test-description">Evalúa parámetros esenciales antes de una cirugía.</p>
                                    </td>
                                    <td data-precio="38000">₡38,000</td>
                                    <td><input type="checkbox" name="test" value="pre-quirurgico" data-precio="38000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Cachorro Completo</strong> (Hg, Urea, Crea, Alb, ALT, ALP, AST, Heces)
                                        <p class="test-description">Diseñado para cachorros, es un conjunto de análisis clínicos diseñado específicamente para evaluar la función renal y la salud general de los cachorros. </p>
                                    </td>
                                    <td data-precio="38000">₡38,000</td>
                                    <td><input type="checkbox" name="test" value="cachorro-completo" data-precio="38000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Adulto Completo</strong> (Hg, Renal, hepático, Alb, TP, CK, Orina, Heces)
                                        <p class="test-description">Examen integral para adultos.</p>
                                    </td>
                                    <td data-precio="48000">₡48,000</td>
                                    <td><input type="checkbox" name="test" value="adulto-completo" data-precio="48000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Adulto Básico</strong> (Hg, Urea, Crea, ALT, AST, ALP, GGT, Glu, Alb, CK)
                                        <p class="test-description">Versión simplificada del perfil adulto.</p>
                                    </td>
                                    <td data-precio="26000">₡26,000</td>
                                    <td><input type="checkbox" name="test" value="adulto-basico" data-precio="26000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Cardíaco Completo</strong> (Hg, AST, ALT, Alb, TP, CK)
                                        <p class="test-description">Evalúa la función cardíaca mediante pruebas.</p>
                                    </td>
                                    <td data-precio="26000">₡26,000</td>
                                    <td><input type="checkbox" name="test" value="cardiaco-completo" data-precio="26000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="perfiles">
                                    <td>
                                        <strong>Perfil Pancreático Canino o Felino</strong> (Hg, Lipasa, Amilasa, AST, ALP, ALT, Glu, GGT, LDH, TBILL, TG, ALB)
                                        <p class="test-description">Especializado en evaluar páncreas con pruebas.</p>
                                    </td>
                                    <td data-precio="30000">₡30,000</td>
                                    <td><input type="checkbox" name="test" value="pancreatico" data-precio="30000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="paneles">
                                    <td>
                                        <strong>Panel Plus</strong> (Alb, ALT, ALP, AMY, Bun, CA, Crea, Bun/Crea, Glob, Alb/Glob, P, TBILL, TP, CHOL, TBA, Electrolitos, glu)
                                        <p class="test-description">Evaluación avanzada de albúmina, electrolitos, proteínas, lípidos y función hepática/renal.</p>
                                    </td>
                                    <td data-precio="25000">₡25,000</td>
                                    <td><input type="checkbox" name="test" value="panel-plus" data-precio="25000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="paneles">
                                    <td>
                                        <strong>Panel General Básico</strong> (Alb, ALP, ALT, AMY, Bun, Crea, Bun-Crea, Ca, Glob, Glo-Alb- Glu, TP, TC, CK, P, BillT)
                                        <p class="test-description">Alternativa simplificada del Panel Plus, con enfoque en función renal, hepática.</p>
                                    </td>
                                    <td data-precio="23000">₡23,000</td>
                                    <td><input type="checkbox" name="test" value="panel-basico" data-precio="23000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="paneles">
                                    <td>
                                        <strong>Panel Electrolitos</strong> (Cl, K, Na, Na-K, CO2, Ca, P, MG)
                                        <p class="test-description">Mide niveles de sodio (Na), potasio (K), cloro (Cl), calcio (Ca), fósforo (P), magnesio (Mg) y otros.</p>
                                    </td>
                                    <td data-precio="18000">₡18,000</td>
                                    <td><input type="checkbox" name="test" value="panel-electrolitos" data-precio="18000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="paneles">
                                    <td>
                                        <strong>Electrolitos para pacientes con Parvovirus</strong> (NA, K, CL)
                                        <p class="test-description">Específico para pacientes con parvovirus, analiza los electrolitos más relevantes para su tratamiento.</p>
                                    </td>
                                    <td data-precio="5000">₡5,000</td>
                                    <td><input type="checkbox" name="test" value="electrolitos-parvo" data-precio="5000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="paneles-intensivos">
                                    <td>
                                        <strong>Panel Intensivo Atropello</strong> (Hg, Glu, Renal, Hepatico)
                                        <p class="test-description">Evaluación rápida para pacientes traumatizados por atropello, enfocado en daño orgánico.</p>
                                    </td>
                                    <td data-precio="28000">₡28,000</td>
                                    <td><input type="checkbox" name="test" value="intensivo-atropello" data-precio="28000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="paneles-intensivos">
                                    <td>
                                        <strong>Panel FLUTD</strong> (Hg, Glu, Renal, Orina, SDMA)
                                        <p class="test-description">Especializado para enfermedad del tracto urinario inferior felino, incluye biomarcador SDMA.</p>
                                    </td>
                                    <td data-precio="50000">₡50,000</td>
                                    <td><input type="checkbox" name="test" value="flutd" data-precio="50000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Tipificación DEA 1 Canino</strong>
                                        <p class="test-description">Determina el grupo sanguíneo DEA 1 en perros, fundamental para transfusiones seguras.</p>
                                    </td>
                                    <td data-precio="28000">₡28,000</td>
                                    <td><input type="checkbox" name="test" value="tipificacion-dea1" data-precio="28000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Tipificación AB Felino</strong>
                                        <p class="test-description">Determina el grupo sanguíneo (A, B o AB) en gatos, esencial antes de cualquier transfusión.</p>
                                    </td>
                                    <td data-precio="28000">₡28,000</td>
                                    <td><input type="checkbox" name="test" value="tipificacion-ab" data-precio="28000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Compatibilidad Sanguínea</strong>
                                        <p class="test-description">Prueba cruzada que confirma la compatibilidad entre donante y receptor.</p>
                                    </td>
                                    <td data-precio="10000">₡10,000</td>
                                    <td><input type="checkbox" name="test" value="compatibilidad" data-precio="10000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Bolsa de sangre canina 500ml + Venoclisis</strong>
                                        <p class="test-description">Unidad de sangre completa canina con equipo de administración incluido.</p>
                                    </td>
                                    <td data-precio="45000">₡45,000</td>
                                    <td><input type="checkbox" name="test" value="bolsa-sangre-canina" data-precio="45000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Bolsa de sangre Felina 250ml + venoclisis</strong>
                                        <p class="test-description">Unidad de sangre completa felina con equipo de administración incluido.</p>
                                    </td>
                                    <td data-precio="50000">₡50,000</td>
                                    <td><input type="checkbox" name="test" value="bolsa-sangre-felina" data-precio="50000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Procedimiento transfusión</strong>
                                        <p class="test-description">Servicio de administración de transfusión con monitorización del paciente.</p>
                                    </td>
                                    <td data-precio="30000">₡30,000</td>
                                    <td><input type="checkbox" name="test" value="procedimiento-transfusion" data-precio="30000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Bolsa Plasma 250ml + venoclisis</strong>
                                        <p class="test-description">Unidad de plasma con equipo para pacientes que requieren factores de coagulación o proteínas.</p>
                                    </td>
                                    <td data-precio="30000">₡30,000</td>
                                    <td><input type="checkbox" name="test" value="bolsa-plasma" data-precio="30000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Procedimiento donador: tipificación+anestesia+bolsa+hemograma</strong>
                                        <p class="test-description">Proceso completo para donantes de primera vez, incluye tipificación y evaluación.</p>
                                    </td>
                                    <td data-precio="53000">₡53,000</td>
                                    <td><input type="checkbox" name="test" value="procedimiento-donador-completo" data-precio="53000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Procedimiento donador ya tipificado: anestesia+bolsa+hemograma</strong>
                                        <p class="test-description">Proceso para donantes recurrentes ya tipificados previamente.</p>
                                    </td>
                                    <td data-precio="28000">₡28,000</td>
                                    <td><input type="checkbox" name="test" value="procedimiento-donador-tipificado" data-precio="28000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Combo transfusión canino sin sangre</strong> (Tipificación DEA 1, procedimiento transfusión, compatibilidad, 2 hemogramas post-transfusión)
                                        <p class="test-description">Paquete completo para transfusión canina, no incluye la bolsa de sangre.</p>
                                    </td>
                                    <td data-precio="80000">₡80,000</td>
                                    <td><input type="checkbox" name="test" value="combo-transfusion-canino" data-precio="80000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunohematologia">
                                    <td>
                                        <strong>Combo transfusión felina sin sangre</strong> (Tipificación AB, procedimiento transfusión, compatibilidad, 2 hemogramas)
                                        <p class="test-description">Paquete completo para transfusión felina, no incluye la bolsa de sangre.</p>
                                    </td>
                                    <td data-precio="80000">₡80,000</td>
                                    <td><input type="checkbox" name="test" value="combo-transfusion-felino" data-precio="80000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="infectocontagiosos">
                                    <td>
                                        <strong>Panel Parvo virus</strong> (Hg, Glu, Renal, Hepático, Heces, Test CPV, Electrolitos)
                                        <p class="test-description">Evaluación completa para pacientes con sospecha de parvovirosis, incluye test específico.</p>
                                    </td>
                                    <td data-precio="35000">₡35,000</td>
                                    <td><input type="checkbox" name="test" value="panel-parvovirus" data-precio="35000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="infectocontagiosos">
                                    <td>
                                        <strong>Panel Distemper</strong> (Hg, Glu, Hepático, Alb, TP, Test CDV)
                                        <p class="test-description">Evaluación para pacientes con sospecha de moquillo canino, incluye test específico para el virus.</p>
                                    </td>
                                    <td data-precio="30000">₡30,000</td>
                                    <td><input type="checkbox" name="test" value="panel-distemper" data-precio="30000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Test sida leucemia</strong>
                                        <p class="test-description">Prueba rápida para detectar virus de inmunodeficiencia felina y leucemia felina.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="test-sida-leucemia" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Test Distemper</strong>
                                        <p class="test-description">Prueba rápida para detección de antígeno de moquillo canino.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="test-distemper" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>ParvoVirus+corona+giardia</strong>
                                        <p class="test-description">Panel combinado para detección rápida de tres patógenos comunes en perros.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="parvovirus-corona-giardia" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Erhlichia canis</strong>
                                        <p class="test-description">Prueba para detectar anticuerpos contra la bacteria transmitida por garrapatas.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="erhlichia-canis" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Erhlichia canis + anaplasma</strong>
                                        <p class="test-description">Panel combinado para detección de dos enfermedades transmitidas por garrapatas.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="erhlichia-anaplasma" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>CaniV4</strong>
                                        <p class="test-description">Panel de detección de 4 enfermedades caninas comunes.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="caniv4" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Parvovirus+Corona</strong>
                                        <p class="test-description">Prueba dual para detección simultánea de dos virus comunes en perros.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="parvovirus-corona" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Giardia</strong>
                                        <p class="test-description">Detección de parásito protozoario intestinal común en mascotas.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="giardia" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="pruebas-rapidas">
                                    <td>
                                        <strong>Giardia+Cryptosporidium</strong>
                                        <p class="test-description">Panel para detección de dos parásitos intestinales comunes en mascotas.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="giardia-crypto" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>CTSH (Vcheck)</strong>
                                        <p class="test-description">Medición de hormona estimulante de tiroides canina mediante tecnología Vcheck.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="ctsh-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>T4 Total (Vcheck)</strong>
                                        <p class="test-description">Medición de tiroxina total mediante tecnología Vcheck.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="t4-total-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>FPL (Vcheck)</strong>
                                        <p class="test-description">Lipasa pancreática felina, para diagnóstico de pancreatitis en gatos.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="fpl-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>AG. Distemper (Vcheck)</strong>
                                        <p class="test-description">Detección de antígeno de distemper canino mediante tecnología Vcheck.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="ag-distemper-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>SDMA (Vcheck)</strong>
                                        <p class="test-description">Dimetilarginina simétrica, biomarcador precoz de enfermedad renal.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="sdma-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>CPL (Vcheck)</strong>
                                        <p class="test-description">Lipasa pancreática canina, para diagnóstico de pancreatitis en perros.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="cpl-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>Cortisol (Vcheck)</strong>
                                        <p class="test-description">Medición de cortisol mediante tecnología Vcheck.</p>
                                    </td>
                                    <td data-precio="consultar">Lab/Recep</td>
                                    <td><input type="checkbox" name="test" value="cortisol-vcheck" data-precio="0" class="test-checkbox-consultar"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>Test rivalta+tira reactiva</strong>
                                        <p class="test-description">Evaluación de líquidos corporales mediante prueba de Rivalta y análisis con tira reactiva.</p>
                                    </td>
                                    <td data-precio="5000">₡5,000</td>
                                    <td><input type="checkbox" name="test" value="test-rivalta" data-precio="5000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>Análisis liquido libre</strong> (Directo, tinción gram, tinción Diff Quick, tira reactiva, opcional prueba Rivalta)
                                        <p class="test-description">Evaluación completa de líquidos corporales mediante múltiples técnicas.</p>
                                    </td>
                                    <td data-precio="18000">₡18,000</td>
                                    <td><input type="checkbox" name="test" value="analisis-liquido-libre" data-precio="18000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="inmunología">
                                    <td>
                                        <strong>Tiempos de coagulación TP/ATTP</strong> (Tubo de citrato)
                                        <p class="test-description">Evaluación de la capacidad de coagulación sanguínea.</p>
                                    </td>
                                    <td data-precio="17000">₡17,000</td>
                                    <td><input type="checkbox" name="test" value="tiempos-coagulacion" data-precio="17000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Hemograma básico</strong> (sin frotis)
                                        <p class="test-description">Análisis sanguíneo básico que incluye conteo celular automatizado.</p>
                                    </td>
                                    <td data-precio="15000">₡15,000</td>
                                    <td><input type="checkbox" name="test" value="hemograma-basico" data-precio="15000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Hemograma Completo</strong> (con frotis)
                                        <p class="test-description">Análisis sanguíneo completo que incluye evaluación microscópica de células.</p>
                                    </td>
                                    <td data-precio="18000">₡18,000</td>
                                    <td><input type="checkbox" name="test" value="hemograma-completo" data-precio="18000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Hemograma + conteo de reticulosis</strong>
                                        <p class="test-description">Hemograma con evaluación adicional de precursores de glóbulos rojos.</p>
                                    </td>
                                    <td data-precio="18000">₡18,000</td>
                                    <td><input type="checkbox" name="test" value="hemograma-reticulosis" data-precio="18000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Hemograma control + conteo de reticulocitos</strong>
                                        <p class="test-description">Seguimiento de pacientes previos con evaluación de precursores de glóbulos rojos.</p>
                                    </td>
                                    <td data-precio="11000">₡11,000</td>
                                    <td><input type="checkbox" name="test" value="hemograma-control-reticulocitos" data-precio="11000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Frotis</strong>
                                        <p class="test-description">Evaluación microscópica de células sanguíneas.</p>
                                    </td>
                                    <td data-precio="7000">₡7,000</td>
                                    <td><input type="checkbox" name="test" value="frotis" data-precio="7000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Hemograma de control</strong>
                                        <p class="test-description">Seguimiento de pacientes previamente diagnosticados.</p>
                                    </td>
                                    <td data-precio="7000">₡7,000</td>
                                    <td><input type="checkbox" name="test" value="hemograma-control" data-precio="7000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Hemograma de control con frotis</strong>
                                        <p class="test-description">Seguimiento de pacientes con evaluación microscópica adicional.</p>
                                    </td>
                                    <td data-precio="9000">₡9,000</td>
                                    <td><input type="checkbox" name="test" value="hemograma-control-frotis" data-precio="9000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Frotis + conteo de reticulocitos</strong>
                                        <p class="test-description">Evaluación microscópica con conteo específico de precursores de glóbulos rojos.</p>
                                    </td>
                                    <td data-precio="11000">₡11,000</td>
                                    <td><input type="checkbox" name="test" value="frotis-reticulocitos" data-precio="11000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Frotis + conteo de reticulocitos de control</strong>
                                        <p class="test-description">Seguimiento de pacientes con evaluación específica de precursores de glóbulos rojos.</p>
                                    </td>
                                    <td data-precio="8000">₡8,000</td>
                                    <td><input type="checkbox" name="test" value="frotis-reticulocitos-control" data-precio="8000" class="test-checkbox"></td>
                                </tr>
                                <tr data-categoria="hemogramas">
                                    <td>
                                        <strong>Conteo de reticulocitos</strong> (Clasificación de Anemia)
                                        <p class="test-description">Evaluación específica de precursores de glóbulos rojos para clasificar anemias.</p>
                                    </td>
                                    <td data-precio="6000">₡6,000</td>
                                    <td><input type="checkbox" name="test" value="conteo-reticulocitos" data-precio="6000" class="test-checkbox"></td>
                                </tr>
                            </tbody>
                            </tfoot>
                        </table>
                    </div>
                </section>
                <section class="selected-services-summary">
                    <h2><i class="fas fa-list-check"></i> Servicios Seleccionados</h2>
                    <div class="summary-container">
                        <ul id="selected-services-list">
                        </ul>
                        <div class="summary-total">
                            <td class="total-price"></td><strong>Total a pagar: </strong><span id="total-price">₡0</span>
                        </div>
                    </div>
                </section>
                
                <div class="signature-section">
                    <div class="signature-line">
                        <p>Médico que requiere los exámenes</p>
                        <select name="medico-encargado" class="form-select doctor-select">
                            <option value="">No hay médico asignado</option>
                            <option value="Dra. Daniela Sancho">Dra. Daniela Sancho</option>
                            <option value="Dra. Alejandra León">Dra. Alejandra León</option>
                            <option value="Dra. Franciny Nuñez">Dra. Franciny Nuñez</option>
                            <option value="Dra. Natalia Alvarado">Dra. Natalia Alvarado</option>
                            <option value="Dra. Karina Madrigal">Dra. Karina Madrigal</option>
                            <option value="Dra. Maria Lourdes">Dra. Maria Lourdes</option>
                            <option value="Dra. Karla">Dra. Karla</option>
                            <option value="Dr. Randall Azofeifa">Dr. Randall Azofeifa</option>
                            <option value="Dr. Luis Coto">Dr. Luis Coto</option>
                        </select>
                    </div>
                </div>
                <footer class="lab-footer">
                    <div class="footer-info">
                        <p><i class="fas fa-hospital"></i> Veterinaria San Martin de Porres</p>
                        <p><i class="fas fa-map-marker-alt"></i>150 metros este del Mall, Zona Centro, San José, Desamparados, San Rafael Abajo, 10311</p>
                        <p><i class="fas fa-phone-alt"></i> 4000 1365</p>
                    </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Guardar</button>
                    <button type="button" class="btn btn-primary" id="btn-pdf"><i class="fas fa-file-pdf"></i> Generar PDF</button>
                </div>
            </footer>
        </form>
    </div>
    
    <script>
        
// Function to load Excel from a GitHub repository
async function loadExcelFromGitHub() {
    try {
        // GitHub raw file URL (replace with your own)
        const gitHubUrl = 'https://github.com/SoporteVet/hojalaboratorio/blob/main/base%20de%20datos.xlsx';
        
        // Fetch the Excel file
        const response = await fetch(gitHubUrl);
        if (!response.ok) throw new Error('No se pudo cargar el archivo desde GitHub');
        
        // Convert to array buffer
        const arrayBuffer = await response.arrayBuffer();
        const data = new Uint8Array(arrayBuffer);
        
        // Process the Excel file
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // Convert to JSON
        excelData = XLSX.utils.sheet_to_json(worksheet);
        databaseLoaded = true;
        
        // Update UI
        updateUIWithLoadedData();
        
        return true;
    } catch (error) {
        console.error('Error loading Excel from GitHub:', error);
        return false;
    }
}

document.getElementById('load-github').addEventListener('click', loadExcelFromGitHub);


      document.addEventListener('DOMContentLoaded', function() {
    // 1. Inicializar fecha actual
    const today = new Date();
    const dateStr = today.getDate() + '/' + (today.getMonth() + 1) + '/' + today.getFullYear();
    document.getElementById('current-date').textContent = dateStr;
    
    // 2. Sistema para calcular el total
    const checkboxes = document.querySelectorAll('.test-checkbox');
    const totalPrice = document.getElementById('total-price');
    
    function updateTotal() {
        let total = 0;
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                total += parseInt(checkbox.dataset.precio);
            }
        });
        totalPrice.textContent = '₡' + total.toLocaleString();
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateTotal);
    });
    
function updateTotal() {
    let total = 0;
    const selectedServicesList = document.getElementById('selected-services-list');
    const summaryTotalPrice = document.getElementById('summary-total-price');
    
    // Clear the current list
    selectedServicesList.innerHTML = '';
    
    // Add selected services to the list and calculate total
    checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
            const precio = parseInt(checkbox.dataset.precio);
            total += precio;
            
            // Get the service name from the row
            const row = checkbox.closest('tr');
            const serviceNameElement = row.querySelector('td:first-child strong');
            const serviceName = serviceNameElement ? serviceNameElement.textContent : 'Servicio';
            
            // Create list item with service and price
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <span>${serviceName}</span>
                <span>₡${precio.toLocaleString()}</span>
            `;
            selectedServicesList.appendChild(listItem);
        }
    });
    
    // Add items for services with "consultar" price
    document.querySelectorAll('.test-checkbox-consultar').forEach(checkbox => {
        if (checkbox.checked) {
            const row = checkbox.closest('tr');
            const serviceNameElement = row.querySelector('td:first-child strong');
            const serviceName = serviceNameElement ? serviceNameElement.textContent : 'Servicio';
            
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <span>${serviceName}</span>
                <span>Consultar precio</span>
            `;
            selectedServicesList.appendChild(listItem);
        }
    });
    
    // Update both total displays
    totalPrice.textContent = '₡' + total.toLocaleString();
    summaryTotalPrice.textContent = '₡' + total.toLocaleString();
    
    // Show/hide the summary section based on whether there are selected services
    const summarySection = document.querySelector('.selected-services-summary');
    if (selectedServicesList.children.length > 0) {
        summarySection.style.display = 'block';
    } else {
        summarySection.style.display = 'none';
    }
}
    
    // 8. Filtrado de servicios por categoría
    const categorySelector = document.getElementById('service-category');
    if (categorySelector) {
        categorySelector.addEventListener('change', function() {
            const selectedCategory = this.value;
            const rows = document.querySelectorAll('#services-table tbody tr');
            
            rows.forEach(row => {
                if (selectedCategory === 'todos' || row.dataset.categoria === selectedCategory) {
                    row.classList.remove('hidden-row');
                } else {
                    row.classList.add('hidden-row');
                }
            });
            
            updateTotal();
        });
    }
});
const btnPdf = document.getElementById('btn-pdf');
if (btnPdf) {
    btnPdf.addEventListener('click', generarPDF);
}

// Función para generar el PDF con formato adecuado
async function generarPDF() {
    try {
        // Mostrar indicador de carga
        const loadingIndicator = document.createElement('div');
        loadingIndicator.className = 'loading-indicator';
        loadingIndicator.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando PDF...';
        document.body.appendChild(loadingIndicator);
        
        // Obtener datos para el nombre del archivo
        const nombrePaciente = document.querySelector('input[name="nombre-paciente"]').value || 'paciente';
        const nombrePropietarioCompleto = document.querySelector('input[name="propietario"]').value || 'cliente';
        const apellidoCliente = nombrePropietarioCompleto.split(' ').pop() || 'cliente';
        
        // Crear una copia del contenedor para manipularlo sin afectar el original
        const elementoOriginal = document.querySelector('.container');
        const elementoParaImprimir = elementoOriginal.cloneNode(true);
        
        // Ocultar botones y secciones no necesarias para el PDF
        const elementosAOcultar = elementoParaImprimir.querySelectorAll('.form-buttons, .historic-section .test-info .test-heading');
        elementosAOcultar.forEach(el => {
            if (el) el.style.display = 'none';
        });
        
        const testHeading = elementoParaImprimir.querySelector('#test-heading');
        if (testHeading) testHeading.style.display = 'none';
        
        // Ocultar la tabla de servicios completa y mostrar solo el resumen
        const tablaServicios = elementoParaImprimir.querySelector('.table-container');
        if (tablaServicios) tablaServicios.style.display = 'none';
        
        // Ocultar el selector de categoría
        const categoryFilter = elementoParaImprimir.querySelector('.category-filter');
        if (categoryFilter) categoryFilter.style.display = 'none';
        
        const serviciosSummary = elementoParaImprimir.querySelector('.selected-services-summary');
        if (serviciosSummary) {
            serviciosSummary.style.display = 'block';
        }
    

// También ocultar la fila del total si no hay elementos seleccionados
const filasVisibles = elementoParaImprimir.querySelectorAll('#services-table tbody tr[style="display: ;"]');
if (filasVisibles.length === 0) {
    const filaTotal = elementoParaImprimir.querySelector('#services-table tfoot tr');
    if (filaTotal) filaTotal.style.display = 'none';
}
        // Crear un contenedor temporal para el PDF
        const tempContainer = document.createElement('div');
        tempContainer.style.position = 'absolute';
        tempContainer.style.left = '-9999px';
        tempContainer.appendChild(elementoParaImprimir);
        document.body.appendChild(tempContainer);
        
        // Esperar a que todas las imágenes se carguen
        const images = tempContainer.getElementsByTagName('img');
        const loadImages = Array.from(images).map(img => {
            return new Promise((resolve, reject) => {
                if (img.complete) {
                    resolve();
                } else {
                    img.onload = resolve;
                    img.onerror = reject;
                }
            });
        });
        
        await Promise.all(loadImages);
        
        // Generar el canvas con html2canvas
        const canvas = await html2canvas(elementoParaImprimir, {
            scale: 2,
            useCORS: true,
            logging: false,
            allowTaint: true
        });
        
        // Crear el PDF con jsPDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Calcular dimensiones para ajustar el contenido a la página
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const imgWidth = 210 - 20; // Ancho de A4 menos margen
        const pageHeight = 320;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // Posicionar la imagen centrada con márgenes
        const x = 10; // margen izquierdo
        const y = 10; // margen superior
        
        // Añadir la imagen al PDF
        pdf.addImage(imgData, 'JPEG', x, y, imgWidth, imgHeight);
        
        // Generar el nombre del archivo
        const fileName = `hoja de laboratorio ${nombrePaciente} ${apellidoCliente}.pdf`;
        
        // Guardar el PDF
        pdf.save(fileName);
        
        // Limpiar
        document.body.removeChild(tempContainer);
        document.body.removeChild(loadingIndicator);
        
        console.log("PDF generado correctamente");
    } catch (error) {
        console.error("Error al generar PDF:", error);
        alert("Ocurrió un error al generar el PDF: " + error.message);
        
        // Limpiar el indicador de carga si hubo error
        const loadingIndicator = document.querySelector('.loading-indicator');
        if (loadingIndicator) {
            document.body.removeChild(loadingIndicator);
        }
    }
}

    </script>
</body>
</html>
